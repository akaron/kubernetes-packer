# Purpose

Deploy a prometheus + grafana inside the k8s cluster, with TLS/HTTPS enabled.
Once done, in browser of host machine, one can open
`https://prometheus.localk8s:9091` to access Prometheus.

Here I use the [ingress-nginx-controller](https://kubernetes.github.io/ingress-nginx/deploy/baremetal/#over-a-nodeport-service)
for `baremetal` using `NodePort` method. It does not require a Load Balancer (physical or
software), just use the `NodePort` method, i.e, if follow the steps below:
```
host browser -> guest (port:9091) -> ingress (nodePort of guest) -> app
```
Note that the `ingress-nginx-controller` exists in all nodes.

In the following, except the `/etc/hosts` and the browser are related to the host machine,
all other operations are in the guest machine
```
vagrant ssh master1
```

# Steps
## Deploy the ingress-nginx-controller
Once the k8s cluster is ready, install the ingress-nginx controller via (in the **guest**
machine)

```
kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v0.35.0/deploy/static/provider/baremetal/deploy.yaml
```

Then need to update a value by running this in command line:
```
kubectl edit svc ingress-nginx-controller -n ingress-nginx
```
set the value of the `externalTrafficPolicy` field of the `ingress-nginx-controller` Service spec to `Local`.


## Prepare certificate
In the **guest** (the VM)
* create the certificate using `sh ./gen_cert.sh`
  - it create self-signed certificate and private key and put them to `kubectl secret`

Then find out the port for https and forward it in the guest machine
```
export HTTPS_NODEPORT=$(kubectl get svc -n ingress-nginx ingress-nginx-controller -o jsonpath="{.spec.ports[1].nodePort}")
socat TCP4-LISTEN:9091,fork TCP4:localhost:$HTTPS_NODEPORT
```

Note: the cert name generated by `get_cert.sh` and deployed to k8s cluster is same as the
one assigned in `prometheus-values.yml`: `server.ingress.tls['secretName']`


## Deploy prometheus and grafana
In the guest machine
```
kubectl create -f /vagrant/k8s/prometheus-pv.yaml
helm install prometheus stable/prometheus --version 11.12.0 -f /vagrant/k8s/prometheus-values.yaml
kubectl create -f /vagrant/k8s/grafana-configmaps.yaml
kubectl create -f /vagrant/k8s/grafana-deployment.yaml
```

## update /etc/hosts in host machine
The apps are served at `prometheus.localk8s` and `grafana.localk8s` (run `kubectl get
ingress` to find out). But the host cannot resolve it. We can simply add these names to
`/etc/hosts` of host machine. The additional lines may look like:

```
172.28.128.3  prometheus.localk8s
172.28.128.3  grafana.localk8s
```

To find the ip (`172.28.128.3` above) address of guest VM, in guest VM:
* find the network interface from `/etc/netplan/50-vagrant.yaml`, something like `enp0s8`
* find the ip address of the interface, such as `ifconfig enp0s8|grep 'inet '`

Now in the browser of host machine, open https://prometheus.localk8s:9091 for prometheus
and https://grafana.localk8s:9091 for grafana.
Because it's self-signed certificate, in modern browsers there should have warnings, which
is safe to ignore.

The default username/password for grafana is `admin/admin`.

## Without TLS
To run without TLS, in the step `Prepare certificate` above
* skip the step `sh ./gen_cert.sh`
* in the jsonpath use `{.spec.ports[0].nodePort}` (use the NodePort which mapped to
  `ingress-nginx-controller` port 80)

Then disable TLS in `prometheus-values.yaml` before run `helm install prometheus ...`

Then use the `NodePort` for port 80 of the ingress controller to access the http page from
the host machine.

Then use `http://` instead of `http://` in browser of host machine.

## Without ingress controller
TODO: verify the steps below

Disable TLS in `prometheus-values.yaml` then follow steps in section `Deploy prometheus
and grafana`. Skip other sections above.

Then port-forward the services (use Prometheus as example):
```
export POD_NAME=$(kubectl get pods --namespace default -l "app=prometheus,component=server" -o jsonpath="{.items[0].metadata.name}")
kubectl --namespace default port-forward $POD_NAME 9090 &
socat TCP4-LISTEN:9091,fork TCP4:localhost:9090 &
```
Then in the browser of host, open `http://localhost:9090` in browser.

# Clean up
Just `kubectl delete -f xxx` could work.
Remember to remove the lines `prometheus.localk8s` and `grafana.localk8s` in the `/etc/hosts` of host machine.


# Notes
* In Grafana webui, if there's no CPU status, probably you forget to set the value of the
  `externalTrafficPolicy` field of the `ingress-nginx-controller` service to `Local`.
* The default values for prometheus deployment can be found in https://github.com/helm/charts/blob/master/stable/prometheus/values.yaml 
* One can also turn off `PersistentStorage` in `prometheus-values.yaml` and don't
  deploy the pv/pvc.  The persistent volume is in `/data/prometheus-data` of node
  `worker1`. Note that there are problems to use the synced folder `/vagrant` (if shared
  by NFS, there's file lock issue; if shared type is `Virtualbox`, there's `mmap` issue?)
* In Grafana ui, if there's no CPU status, probably you forget to set the value of the
  `externalTrafficPolicy` field of the `ingress-nginx-controller` service to `Local`.
